{"title":"App 多渠道打包及重签名方案","date":"2019-03-02T18:41:39.000Z","date_formatted":{"ll":"Mar 3, 2019","L":"03/03/2019","MM-DD":"03-03"},"link":"solution-of-app-muti-channel-pack","tags":["重签名"],"categories":["Android","iOS"],"updated":"2019-12-28T12:18:25.020Z","content":"<p>众所周知，渠道包是国内 Android 应用市场中常用的分发方式。渠道包中会包含不同的渠道信息，方便我们后续统计 App 在各分发渠道的下载量、用户量、留存率等，有针对地调整应用内容或是推广方案等。随着国内 iOS 应用上架越来越难，衍生出了很多企业包，为了方便采集数据，也会用多渠道的方案。</p>\n<a id=\"more\"></a>\n\n<p>另外，项目进展过程中，可能会出现一些临时新增渠道的需求，这时回到工程中重新打包是比较费时的，有没有办法加快打包速度呢？下文中分享了一些方案。</p>\n<h2 id=\"iOS-多渠道打包方案\">iOS 多渠道打包方案<a href=\"solution-of-app-muti-channel-pack#iOS-多渠道打包方案\"></a></h2><p>iOS 打渠道包目前想到的就只有两种方式，一种是通过<a href=\"solution-of-app-muti-channel-pack#muti-target-way\">多 target 方式</a>，另一种是<a href=\"solution-of-app-muti-channel-pack#revise-plist-way\">修改 plist 文件方式</a>。</p>\n<h3 id=\"多-target-方式\"><span id=\"muti-target-way\">多 target 方式</span><a href=\"solution-of-app-muti-channel-pack#多-target-方式\"></a></h3><p>点击项目中的 target，右键选择 <code>Duplicate</code>。可以修改下图标红框的三处：target 名称、plist 名称和 scheme 名称。</p>\n<img src=\"/solution-of-app-muti-channel-pack/target-copy.png\" class=\"article-img\">\n\n<p>判断当前是哪个 target，可以通过添加宏定义实现，方式就是在 <code>Build Settings</code> 找到 <code>Preprocessor Macros</code>，填入宏定义名。</p>\n<p>代码中这样判断：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">#ifdef  TARGET1MACROS</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">2</span></pre></td><td class=\"code\"><pre><span class=\"line\">    &#x2F;&#x2F; target1</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">3</span></pre></td><td class=\"code\"><pre><span class=\"line\">#elif defined TARGET2MACROS</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">4</span></pre></td><td class=\"code\"><pre><span class=\"line\">    &#x2F;&#x2F; target2</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">5</span></pre></td><td class=\"code\"><pre><span class=\"line\">#endif</span></pre></td></tr></table></div></figure>\n\n<p>具体打包脚本就不介绍了，读者可以自行网上搜索，这种方式的缺点是一个渠道打一次，效率较低。下面着重分享修改 plist 的批量打包方式。</p>\n<h3 id=\"修改-plist-方式\"><span id=\"revise-plist-way\">修改 plist 方式</span><a href=\"solution-of-app-muti-channel-pack#修改-plist-方式\"></a></h3><p>下面用一个简单的 Demo 演示一下：</p>\n<p><strong>第一步：</strong>创建工程名为 MultiChannelDemo 的项目，并在项目中新建一个 <code>Channel.plist</code> 文件，plist 中设置 Channel 字段，值为 channel01。然后在页面上设置一个 label 标签用于显示当前的渠道名称，渠道名可以通过下面的代码获取到：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">NSDictionary *channelDic &#x3D; [NSDictionary dictionaryWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@&quot;Channel&quot; ofType:@&quot;plist&quot;]];</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">2</span></pre></td><td class=\"code\"><pre><span class=\"line\">NSString *channel &#x3D; channelDic[@&quot;Channel&quot;];</span></pre></td></tr></table></div></figure>\n<p><strong>第二步：</strong>把这个项目用可用的证书正常打一个母包，解压这个 ipa 包可以获得一个名为 <code>Payload</code> 的文件夹，里面是一个 .app 文件，右键显示其包内容，内容如下：。</p>\n<img src=\"/solution-of-app-muti-channel-pack/package-content.png\" class=\"article-img\">\n\n<p>可以看到，里面的 <code>Channel.plist</code> 也就是在前面工程中新建的存储渠道信息的 plist，我们会修改里面的 Channel 再生成新的渠道包。</p>\n<p><strong>第三步：</strong>提取描述文件用于重签名，上一步中 Payload 的文件夹里有一个 <code>embedded.mobileprovision</code> 文件，这就是我们需要的文件。</p>\n<p><strong>第四步：</strong>新建一个纯文本，里面输入你要新增的渠道号，如：</p>\n<img src=\"/solution-of-app-muti-channel-pack/channel-list-txt.png\" class=\"article-img\">\n\n<p><strong>第五步：</strong>写一个脚本文件，内容如下：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">2</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">3</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 输入的包名</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">4</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">5</span></pre></td><td class=\"code\"><pre><span class=\"line\">name=\"MultiChannelDemo\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">6</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">7</span></pre></td><td class=\"code\"><pre><span class=\"line\">echo \"------SDK渠道包----------\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">8</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">9</span></pre></td><td class=\"code\"><pre><span class=\"line\">appName=\"$&#123;name&#125;.app\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">10</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">11</span></pre></td><td class=\"code\"><pre><span class=\"line\">plistBuddy=\"/usr/libexec/PlistBuddy\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">12</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">13</span></pre></td><td class=\"code\"><pre><span class=\"line\">configName=\"Payload/$&#123;appName&#125;/Channel.plist\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">14</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">15</span></pre></td><td class=\"code\"><pre><span class=\"line\">ipa=\"$&#123;name&#125;.ipa\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">16</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">17</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 输出的新包所在的文件夹名</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">18</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">19</span></pre></td><td class=\"code\"><pre><span class=\"line\">outUpdateAppDir=\"ChannelPackages\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">20</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">21</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> entitlements.plist路径</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">22</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">23</span></pre></td><td class=\"code\"><pre><span class=\"line\">entitlementsDir=\"entitlements.plist\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">24</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">25</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 切换到当前目录</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">26</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">27</span></pre></td><td class=\"code\"><pre><span class=\"line\">currDir=$&#123;PWD&#125;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">28</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">29</span></pre></td><td class=\"code\"><pre><span class=\"line\">cd $&#123;currDir&#125;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">30</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">31</span></pre></td><td class=\"code\"><pre><span class=\"line\">echo \"-----$&#123;currDir&#125;\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">32</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">33</span></pre></td><td class=\"code\"><pre><span class=\"line\">rm -rf Payload</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">34</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">35</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 解压缩-o：覆盖文件 -q：不显示解压过程</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">36</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">37</span></pre></td><td class=\"code\"><pre><span class=\"line\">unzip -o -q $&#123;ipa&#125;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">38</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">39</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 删除旧的文件夹，重新生成</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">40</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">41</span></pre></td><td class=\"code\"><pre><span class=\"line\">rm -rf $&#123;outUpdateAppDir&#125;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">42</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">43</span></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir $&#123;outUpdateAppDir&#125;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">44</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">45</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 删除旧的 entitlements.plist，重新生成</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">46</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">47</span></pre></td><td class=\"code\"><pre><span class=\"line\">rm -rf $&#123;entitlementsDir&#125;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">48</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">49</span></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/libexec/PlistBuddy -x -c \"print :Entitlements \" /dev/stdin &lt;&lt;&lt; $(security cms -D -i Payload/$&#123;appName&#125;/embedded.mobileprovision) &gt; entitlements.plist</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">50</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">51</span></pre></td><td class=\"code\"><pre><span class=\"line\">echo \"------------------------开始打包程序------------------------\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">52</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">53</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 渠道列表文件开始打包</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">54</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">55</span></pre></td><td class=\"code\"><pre><span class=\"line\">for line in $(cat ChannelList.txt)</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">56</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">57</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 循环数组，修改渠道信息</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">58</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">59</span></pre></td><td class=\"code\"><pre><span class=\"line\">do</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">60</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">61</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 修改 plist 中的 Channel 值</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">62</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">63</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\">plistBuddy -c <span class=\"string\">\"Set :Channel <span class=\"variable\">$line</span>\"</span> <span class=\"variable\">$&#123;configName&#125;</span></span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">64</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">65</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> app 重签名</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">66</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">67</span></pre></td><td class=\"code\"><pre><span class=\"line\">rm -rf Payload/$&#123;appName&#125;/_CodeSignature</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">68</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">69</span></pre></td><td class=\"code\"><pre><span class=\"line\">cp embedded.mobileprovision \"Payload/$&#123;appName&#125;/embedded.mobileprovision\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">70</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">71</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 填入可用的证书 ID</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">72</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">73</span></pre></td><td class=\"code\"><pre><span class=\"line\">codesign -f -s \"iPhone Distribution: XXXXXX.\" Payload/$&#123;appName&#125;  --entitlements $&#123;entitlementsDir&#125;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">74</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">75</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 若输出 Payload/MultiChannelDemo.app: replacing existing signature 说明重签名完成</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">76</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">77</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 压缩 -r:递归处理，将指定目录下的所有文件和子目录一并处理 -q:不显示处理过程</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">78</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">79</span></pre></td><td class=\"code\"><pre><span class=\"line\">zip -rq \"$&#123;outUpdateAppDir&#125;/$line.ipa\" Payload</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">80</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">81</span></pre></td><td class=\"code\"><pre><span class=\"line\">echo \"........渠道$&#123;line&#125;打包已完成\"</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">82</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">83</span></pre></td><td class=\"code\"><pre><span class=\"line\">done</span></pre></td></tr></table></div></figure>\n<p>脚本里的信息请根据你实际情况修改，。到这里准备工作都完成了，需要的文件如下图所示：</p>\n<img src=\"/solution-of-app-muti-channel-pack/prepare-file.png\" class=\"article-img\">\n\n<p><strong>第六步：</strong>在当前目录下执行脚本文件：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">sh ChannelPackage.sh</span></pre></td></tr></table></div></figure>\n\n<p>打包完成后生成的 <code>ChannelPackages</code> 文件夹下，就是我们需要的渠道包：</p>\n<img src=\"/solution-of-app-muti-channel-pack/package-result.png\" class=\"article-img\">\n\n<p>这种自动化打包的方式，可以规避掉 Xcode 本身打包编译的部分时间，快速出包。</p>\n<h2 id=\"Android-多渠道打包方案\">Android 多渠道打包方案<a href=\"solution-of-app-muti-channel-pack#Android-多渠道打包方案\"></a></h2><p>下文介绍的是美团技术团队开源的 <a href=\"https://github.com/Meituan-Dianping/walle\" target=\"_blank\" rel=\"noopener\">Walle</a>，它有 <a href=\"solution-of-app-muti-channel-pack#gradle-way\">Gradle 插件</a>和<a href=\"solution-of-app-muti-channel-pack#command-way\">命令行</a>两种使用方式，前者快速集成，后者满足自定义需求。</p>\n<h3 id=\"Gladle-插件方式\"><span id=\"gradle-way\">Gladle 插件方式</span><a href=\"solution-of-app-muti-channel-pack#Gladle-插件方式\"></a></h3><h4 id=\"配置-build-gradle\">配置 build.gradle<a href=\"solution-of-app-muti-channel-pack#配置-build-gradle\"></a></h4><p>在项目根目录下的 <code>build.gradle</code> 文件中添加 Walle 插件依赖：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">buildscript &#123;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">2</span></pre></td><td class=\"code\"><pre><span class=\"line\">    dependencies &#123;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">3</span></pre></td><td class=\"code\"><pre><span class=\"line\">        classpath <span class=\"string\">'com.meituan.android.walle:plugin:1.1.6'</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">4</span></pre></td><td class=\"code\"><pre><span class=\"line\">    &#125;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">5</span></pre></td><td class=\"code\"><pre><span class=\"line\">&#125;</span></pre></td></tr></table></div></figure>\n\n<p>在 app 目录下的 <code>build.gradle</code> 文件中 apply 插件：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">apply plugin: <span class=\"string\">'walle'</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">2</span></pre></td><td class=\"code\"><pre><span class=\"line\"></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">3</span></pre></td><td class=\"code\"><pre><span class=\"line\">dependencies &#123;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">4</span></pre></td><td class=\"code\"><pre><span class=\"line\">    compile <span class=\"string\">'com.meituan.android.walle:library:1.1.6'</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">5</span></pre></td><td class=\"code\"><pre><span class=\"line\">&#125;</span></pre></td></tr></table></div></figure>\n\n<h4 id=\"配置插件\">配置插件<a href=\"solution-of-app-muti-channel-pack#配置插件\"></a></h4><p>在 app 目录下的 <code>build.gradle</code> 文件中进行渠道配置：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">walle &#123;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">2</span></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\">// 指定渠道包的输出路径</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">3</span></pre></td><td class=\"code\"><pre><span class=\"line\">    apkOutputFolder = <span class=\"keyword\">new</span> File(<span class=\"string\">\"$&#123;project.buildDir&#125;/outputs/channels\"</span>);</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">4</span></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\">// 定制渠道包的APK的文件名称</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">5</span></pre></td><td class=\"code\"><pre><span class=\"line\">    apkFileNameFormat = <span class=\"string\">'$&#123;appName&#125;_v$&#123;versionName&#125;_$&#123;channel&#125;.apk'</span>;</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">6</span></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\">// 渠道配置文件</span></span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">7</span></pre></td><td class=\"code\"><pre><span class=\"line\">    channelFile = <span class=\"keyword\">new</span> File(<span class=\"string\">\"$&#123;project.getProjectDir()&#125;/channel\"</span>)</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">8</span></pre></td><td class=\"code\"><pre><span class=\"line\">&#125;</span></pre></td></tr></table></div></figure>\n<p>渠道配置文件里的内容格式详见：<a href=\"https://github.com/Meituan-Dianping/walle/blob/master/app/channel\" target=\"_blank\" rel=\"noopener\">渠道配置文件示例</a>。</p>\n<h4 id=\"如何获取渠道信息\">如何获取渠道信息<a href=\"solution-of-app-muti-channel-pack#如何获取渠道信息\"></a></h4><p>在需要填写渠道信息的地方引用这段代码：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">String channel = WalleChannelReader.getChannel(<span class=\"keyword\">this</span>.getApplicationContext());</span></pre></td></tr></table></div></figure>\n\n<h4 id=\"如何生成渠道包\">如何生成渠道包<a href=\"solution-of-app-muti-channel-pack#如何生成渠道包\"></a></h4><p>用 <code>assemble${variantName}Channels</code> 指令，导出 apk 包。</p>\n<h3 id=\"命令行方式\"><span id=\"command-way\">命令行方式</span><a href=\"solution-of-app-muti-channel-pack#命令行方式\"></a></h3><p>通过命令行方式，可以不打开 IDE，直接导出新渠道的 apk。步骤如下：</p>\n<p>首先，新建一个文件夹，取用一个上面步骤导出的 apk 包，再下载 <a href=\"https://github.com/Meituan-Dianping/walle/releases\" target=\"_blank\" rel=\"noopener\">walle-cli-all.jar</a>，两者都放置在这个文件夹目录下。</p>\n<p>然后，在文件夹目录下执行命令：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar walle-cli-all.jar put -c <span class=\"variable\">$&#123;channelName&#125;</span> <span class=\"variable\">$&#123;apkName&#125;</span>.apk</span></pre></td></tr></table></div></figure>\n\n<p>若上面的命令执行成功，会在当前目录下生成新的渠道包，名称为 <code>${apkName}_${channelName}.apk</code></p>\n<p>如果要批量写入渠道，可以这样，渠道之间用逗号隔开：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar walle-cli-all.jar batch -c <span class=\"variable\">$&#123;channelName0&#125;</span>,<span class=\"variable\">$&#123;channelName1&#125;</span>,<span class=\"variable\">$&#123;channelName2&#125;</span> <span class=\"variable\">$&#123;apkName&#125;</span>.apk</span></pre></td></tr></table></div></figure>\n\n<p>或者指定渠道配置文件：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar walle-cli-all.jar batch -c <span class=\"variable\">$&#123;channelFile&#125;</span> <span class=\"variable\">$&#123;apkName&#125;</span>.apk</span></pre></td></tr></table></div></figure>\n\n<blockquote>\n<p>如果要写入额外信息，参考<a href=\"https://github.com/Meituan-Dianping/walle/blob/master/walle-cli/README.md\" target=\"_blank\" rel=\"noopener\">官方文档</a>。</p>\n</blockquote>\n<p>如果要检查/显示渠道，命令为：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar walle-cli-all.jar show <span class=\"variable\">$&#123;apkName&#125;</span>.apk</span></pre></td></tr></table></div></figure>\n\n<p>Walle 现在既能满足新应用签名方案对安全性的要求，也能满足对渠道包打包时间的要求，有需要的可以尝试。</p>\n","prev":{"title":"【译】Fucking SwiftUI","link":"fucking-swiftUI"},"next":{"title":"海外开发者账号上架总结","link":"how-to-use-an-overseas-developer-account-to-upload-an-iOS-app"},"plink":"https://blog.fiteen.top/solution-of-app-muti-channel-pack/","toc":[{"title":"iOS 多渠道打包方案","id":"iOS-多渠道打包方案","index":"1","children":[{"title":"多 target 方式</span>","id":"muti-target-way","index":"1.1"},{"title":"修改 plist 方式</span>","id":"revise-plist-way","index":"1.2"}]},{"title":"Android 多渠道打包方案","id":"Android-多渠道打包方案","index":"2","children":[{"title":"Gladle 插件方式</span>","id":"gradle-way","index":"2.1","children":[{"title":"配置 build.gradle","id":"配置-build-gradle","index":"2.1.1"},{"title":"配置插件","id":"配置插件","index":"2.1.2"},{"title":"如何获取渠道信息","id":"如何获取渠道信息","index":"2.1.3"},{"title":"如何生成渠道包","id":"如何生成渠道包","index":"2.1.4"}]},{"title":"命令行方式</span>","id":"command-way","index":"2.2"}]}],"copyright":{"author":"FiTeen","link":"<a href=\"https://blog.fiteen.top/solution-of-app-muti-channel-pack/\" title=\"App 多渠道打包及重签名方案\">https://blog.fiteen.top/solution-of-app-muti-channel-pack/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}