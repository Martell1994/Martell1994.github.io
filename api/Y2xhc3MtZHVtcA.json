{"title":"iOS 逆向分析之 class-dump","date":"2017-10-04T16:13:05.000Z","date_formatted":{"ll":"Oct 5, 2017","L":"10/05/2017","MM-DD":"10-05"},"link":"class-dump","tags":["逆向"],"categories":["iOS"],"updated":"2019-12-05T03:29:17.420Z","content":"<h2 id=\"class-dump\">class-dump<a href=\"class-dump#class-dump\"></a></h2><p>class-dump 是一个命令行工具，通过利用 Objective-C 语言的 runtime 特性，提取存储在 Mach-O 文件中的类文件、协议、分类等信息，并统一表现在 .h 头文件中。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"安装\">安装<a href=\"class-dump#安装\"></a></h3><ol>\n<li><p>下载 <a href=\"http://stevenygard.com/download/class-dump-3.5.dmg\" target=\"_blank\" rel=\"noopener\">class-dump-3.5.dmg</a>（若链接无效，请戳<a href=\"!http://stevenygard.com/projects/class-dump/\">官方网址</a>）</p>\n</li>\n<li><p>打开终端，输入</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">open /usr/<span class=\"built_in\">local</span>/bin</span></pre></td></tr></table></div></figure>\n</li>\n<li><p>将下载拿到的 class-dump 拷贝到 /usr/local/bin 目录下</p>\n</li>\n<li><p>赋予其可执行权限，终端输入:</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">sudo chmod 777 /usr/<span class=\"built_in\">local</span>/bin/class-dump</span></pre></td></tr></table></div></figure>\n</li>\n<li><p>至此安装成功，并可以通过 <code>class-dump --help</code> 查看用法和版本</p>\n</li>\n</ol>\n<h3 id=\"使用\">使用<a href=\"class-dump#使用\"></a></h3><ol>\n<li>下载一个 ipa 文件，先将文件改为 zip 格式，解压后得到 .app 的目标文件</li>\n<li>终端输入命令，格式为 <code>class-dump -H [.app文件路径] -o [输出文件夹路径]</code></li>\n<li>假如此时输出的文件中未得到目标的 .h，结果中什么都没有或者只有一个 CDStructures.h，说明需要砸壳</li>\n</ol>\n<h2 id=\"dumpdecrypted\">dumpdecrypted<a href=\"class-dump#dumpdecrypted\"></a></h2><p>从 AppStore 下载安装的 App 被苹果默认加了一层壳，需要通过砸壳进行逆向分析。</p>\n<h3 id=\"工具\">工具<a href=\"class-dump#工具\"></a></h3><ul>\n<li><p><a href=\"https://github.com/stefanesser/dumpdecrypted\" target=\"_blank\" rel=\"noopener\">dumpdecrypted.dylib</a></p>\n<ul>\n<li><p><a href=\"https://github.com/stefanesser/dumpdecrypted/archive/master.zip\" target=\"_blank\" rel=\"noopener\">下载</a></p>\n</li>\n<li><p>编译安装</p>\n<p>1、在终端进入下载的解压文件的目录：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> [dumpdecrypted-master<span class=\"string\">'s filePath]</span></span></pre></td></tr></table></div></figure>\n\n<p>2、执行 <code>ls</code> 里面存在三个文件：Makefile、README、dumpdecrypted.c</p>\n<p>3、执行 <code>make</code> ，在当前目录下会多出 dumpdecrypted.dylib 和 dumpdecrypted.o，前者就是我们需要的工具</p>\n</li>\n</ul>\n</li>\n<li><p>一台越狱手机</p>\n</li>\n</ul>\n<h3 id=\"操作步骤\">操作步骤<a href=\"class-dump#操作步骤\"></a></h3><p>使用越狱手机前往 AppStore 下载目标 App 并打开。</p>\n<h4 id=\"1-使用-ssh-连接手机\">1. 使用 ssh 连接手机<a href=\"class-dump#1-使用-ssh-连接手机\"></a></h4><p>1.1 越狱手机和电脑连同一个 wifi，查看手机所处当前网络的 IP 地址，打开终端 A，输入指令：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">ssh root@[手机当前网络的 IP 地址]</span></pre></td></tr></table></div></figure>\n\n<p>1.2 通过命令<code>ps -e</code>找到目标 App 对应的进程，如果该 App 为当前打开的应用，可以关注最下面的几条进程，形如：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">[进程号] ??         [时间] [目标 App 在手机中路径]</span></pre></td></tr></table></div></figure>\n\n<p>路径形如 </p>\n<p><code>/var/mobile/Containers/Bundle/Application/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/xx.app/xx</code></p>\n<p>将其记录下来备用。</p>\n<p>1.3 附加进程指令：<code>cycript -p [进程号]</code></p>\n<p>获取 App 在沙盒 Documents 的路径：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">[[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask]</span></pre></td></tr></table></div></figure>\n\n<p>路径形如：<code>/var/mobile/Containers/Data/Application/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/Documents</code></p>\n<p>将其记录下来备用。</p>\n<h4 id=\"2-注入-dumpdecrypted-dylib\">2. 注入 dumpdecrypted.dylib<a href=\"class-dump#2-注入-dumpdecrypted-dylib\"></a></h4><p>2.1 新开终端 B（可使用快捷键 command + T）</p>\n<p>2.2 使用 scp 指令将 dumpdecrypted.dylib 拷贝到目标 App 的 Documents 目录下。</p>\n<p>指令为：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">scp [dumpdecrypted.dylib 所在的完整路径] root@[手机当前网络的 IP 地址]:[目标 App 在手机中路径]</span></pre></td></tr></table></div></figure>\n\n<p>终端会提示输入密码，默认为 <code>alpine</code>。</p>\n<h4 id=\"3-砸壳\">3. 砸壳<a href=\"class-dump#3-砸壳\"></a></h4><p>3.1 回到终端 A，<code>cd</code>  进入步骤 1.3 中 App 在沙盒 Documents 的路径</p>\n<p>3.2 执行如下指令：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib [步骤 1.2 中目标 App 在手机中路径]</span></pre></td></tr></table></div></figure>\n\n<p>3.3 执行 <code>ls</code> 指令查看当前目录下是否有 <code>.decrypted</code> 的文件来确定砸壳是否成功</p>\n<h4 id=\"4-class-dump-导出-App-头文件\">4. class-dump 导出 App 头文件<a href=\"class-dump#4-class-dump-导出-App-头文件\"></a></h4><p>4.1 回到终端 B，将.decrypted 文件拷贝到电脑目录下，指令为：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">scp root@[手机当前网络的 IP 地址]:[步骤 1.3 中App 在沙盒 Documents 的路径]/WeChat.decrypted [自定义的电脑目录]</span></pre></td></tr></table></div></figure>\n\n<p>终端会提示输入密码，默认为 <code>alpine</code>。</p>\n<p>4.2 通过如下指令获取目标 App 的所有头文件</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">class-dump -s -S -H --arch [指令集] [步骤 4.1 中的.decrypted 文件路径] -o [自定义的输出目录]</span></pre></td></tr></table></div></figure>\n\n<p>指令集需对应当前越狱手机的型号，参考下表：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span></pre></td><td class=\"code\"><pre><span class=\"line\">armv6：iPhone | iPhone2 | iPhone3G</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">2</span></pre></td><td class=\"code\"><pre><span class=\"line\">armv7：iPhone3GS | iPhone4 | iPhone4S</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">3</span></pre></td><td class=\"code\"><pre><span class=\"line\">armv7s：iPhone5 | iPhone5C</span></pre></td></tr><tr><td class=\"gutter\"><pre><span class=\"line\">4</span></pre></td><td class=\"code\"><pre><span class=\"line\">arm64：iPhone5S | iPhone6 | iPhone6Plus | iPhone6S  | iPhone6SPlus | iPhone7 | iPhone7Plus | iPhone8 | iPhone8Plus | iPhoneX</span></pre></td></tr></table></div></figure>\n","prev":{"title":"『2017』去年今日此门中","link":"annual-summary-2017"},"next":{"title":"iOS 自动布局进阶之巧用 IBInspectable 和 IB_DESIGNABLE","link":"how-to-use-IBInspectable-and-IB-DESIGNABLE"},"plink":"https://blog.fiteen.top/class-dump/","toc":[{"title":"class-dump","id":"class-dump","index":"1","children":[{"title":"安装","id":"安装","index":"1.1"},{"title":"使用","id":"使用","index":"1.2"}]},{"title":"dumpdecrypted","id":"dumpdecrypted","index":"2","children":[{"title":"工具","id":"工具","index":"2.1"},{"title":"操作步骤","id":"操作步骤","index":"2.2","children":[{"title":"1. 使用 ssh 连接手机","id":"1-使用-ssh-连接手机","index":"2.2.1"},{"title":"2. 注入 dumpdecrypted.dylib","id":"2-注入-dumpdecrypted-dylib","index":"2.2.2"},{"title":"3. 砸壳","id":"3-砸壳","index":"2.2.3"},{"title":"4. class-dump 导出 App 头文件","id":"4-class-dump-导出-App-头文件","index":"2.2.4"}]}]}],"copyright":{"author":"FiTeen","link":"<a href=\"https://blog.fiteen.top/class-dump/\" title=\"iOS 逆向分析之 class-dump\">https://blog.fiteen.top/class-dump/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}